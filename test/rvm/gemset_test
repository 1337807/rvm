#!/bin/zsh

source ./test/setup
initialize_rvm

# tests: 29
# assertions: 290

original_dir=$(pwd)

gem build rvm.gemspec > /dev/null
filename=$(ls rvm*.gem | head -n 1)

setup_testset() { rvm 1.9.1 ; }
remove_gemset_files() { rm *.gems ; }

remove_gemsets() {
  if [ -d ~/.rvm/gems/ruby/1.9.1%${1} ] ; then rm -rf ~/.rvm/gems/ruby/1.9.1%${1} ; fi
  unset GEM_HOME GEM_PATH
}

test_reset() { unset GEM_HOME ; __rvm_cleanup_variables ; }
setup_testset
btu_test "rvm gems testset ; gemdir=\$(gem env gemdir)"
assert match "ruby\/1.9.1%testset$" "$gemdir"
test_reset

btu_test 'rvm gems testset ; gems=\$(rvm gems name)'
assert string_eq "testset" "$gems"
test_reset

btu_test 'rvm gems testset; gems_dir=\$(rvm gems dir)'
assert match "1.9.1%testset$" "$gems_dir"
test_reset

btu_test "rvm gems testset ; gem install --no-rdoc --no-ri $filename > /dev/null ; rvm gems dump"
assert file_exists "testset.gems"
assert file_contains "^rvm" "testset.gems"
test_reset ; remove_gemsets "testset" ; remove_gemset_files

btu_test "rvm gems testset ; gem install --no-rdoc --no-ri $filename > /dev/null ; rvm gems dump my_testset.gems"
assert no_directory "$rvm_gem_path/ruby/1.9.1%my_testset"
assert file_exists "my_testset.gems"
assert file_contains "^rvm" "my_testset.gems"
test_reset ; remove_gemsets "testset" ; remove_gemsets "my_testset" ; remove_gemset_files

btu_test "rvm gems testset ; gem install --no-rdoc --no-ri $filename > /dev/null ; rvm gems dump my_testset.gems"
assert no_directory "$rvm_gem_path/ruby/1.9.1%my_testset"
assert file_exists "my_testset.gems"
assert file_does_not_exist "testset.gems"
assert file_does_not_contain "^rvm" "my_testset.gems"
test_reset ; remove_gemsets "testset" ; remove_gemsets "my_testset" ; remove_gemset_files

btu_test "rvm gems testset ; gem install --no-rdoc --no-ri $filename > /dev/null ; rvm gems dump my_testset2.gems"
assert file_exists "my_testset2.gems"
assert file_contains "^rvm" "my_testset2.gems"
test_reset ; remove_gemsets "my_testset2"; remove_gemset_files

rvm gems testset ; gem_dir="$(gem env gemdir)" ; mkdir -p $gem_dir
btu_test "rvm gems testset ; gem install --no-rdoc --no-ri $filename > /dev/null ; rvm --force gems delete testset"
assert no_directory $gem_dir
test_reset ; remove_gemsets "testset"

btu_test "rvm gems testset4 ; echo '$filename' > testset4.gems ; rvm gems load  > /dev/null"
assert match "rvm" "$(rvm gems testset4 ; gem list | tr "\n" ",")"
test_reset ; remove_gemsets "testset4"

btu_test "rvm gems testset5 ; echo '$filename' > my_testset5.gems ; rvm gems load my_testset5.gems > /dev/null"
assert no_directory "$rvm_gem_path/ruby/1.9.1%my_testset5"
assert match "rvm" "$(rvm gems testset5 ; gem list | tr "\n" ",")"
test_reset ; remove_gemsets "testset5" ; remove_gemset_files

btu_test "rvm gems testset6 ; rvm gems testset7"
assert match "testset6" "$(rvm gems list | tr "\n" ", ")"
assert match "testset7" "$(rvm gems list | tr "\n" ", ")"
test_reset ; remove_gemsets "testset6" ; remove_gemsets "testset7"

rvm_ruby_string='1.9.1%testset8'      ; valid_string="ruby-1.9.1-p243"    ; btu_test "rvm_ruby_string=$rvm_ruby_string ; __rvm_select"
assert match "ruby\/1.9.1%testset8$" "$rvm_ruby_gem_home"
test_reset ; remove_gemsets "testset8"

rvm_ruby_string='ruby-1.9.1%testset9' ; valid_string="ruby-1.9.1-p243"    ; btu_test "rvm_ruby_string=$rvm_ruby_string ; __rvm_select"
assert match "ruby\/1.9.1%testset9$" "$rvm_ruby_gem_home"
test_reset ; remove_gemsets "testset9"

rvm_ruby_string='ruby-1.9.1-p243%testset10' ; valid_string="ruby-1.9.1-p243"    ; btu_test "rvm_ruby_string=$rvm_ruby_string ; __rvm_select"
assert match "ruby\/1.9.1%testset10$" "$rvm_ruby_gem_home"
test_reset ; remove_gemsets "testset10"

setup_testset
btu_test "rvm 1.9.1%testset11 ; gemdir=\$(gem env gemdir)"
assert match "ruby\/1.9.1%testset11$" "$gemdir"
test_reset

rvm 1.9.1 ; rvm gems testset11 ; gem install --no-rdoc --no-ri $filename > /dev/null
rvm ree ; rvm gems testset12 ; gem install --no-rdoc --no-ri $filename > /dev/null
btu_test "output=\"\$(rvm 1.9.1%testset11,ree%testset12 gem list)\""
assert match "ruby-1\.9\.1-p243.*rvm" "$(echo "$output" | tr "\n" ", ")"
assert match "ree-1\..*rvm" "$(echo "$output" | tr "\n" ", ")"
test_reset


btu_test "rvm gems testset13; output=\"\$(rvm 1.9.1,ree gem env gemdir)\""
assert match "ruby/1.9.1%testset13" "$(echo "$output" |  tr "\n" ", ")"
assert match "ree/1.8.7%testset13" "$(echo "$output" |  tr "\n" ", ")"
test_reset ; rvm 1.9.1,ree gems --force delete testset13

if [ -z "$rvm_teset_suite_flag" ] ; then btu_summary ; fi

